name: Website Monitor

on:
  schedule:
    - cron: '*/15 * * * *'  # Her 15 dakikada bir Ã§alÄ±ÅŸÄ±r
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (main branch)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # tÃ¼m branch'lere eriÅŸmek iÃ§in

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests python-telegram-bot==13.15

      - name: Run monitor script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python check_site.py

      - name: Checkout state branch
        run: |
          git fetch origin state || echo "state branch'i yok, yeni oluÅŸturulacak"
          git checkout -B state origin/state || git checkout -b state

      - name: Copy latest hash file from run
        run: |
          # EÄŸer monitor.py dosyasÄ± yeni site_hash.txt dosyasÄ± oluÅŸturduysa onu al
          if [ -f site_hash.txt ]; then
            echo "Yeni hash bulundu. Commit iÃ§in hazÄ±rlanÄ±yor."
          else
            echo "site_hash.txt bulunamadÄ±. Muhtemelen deÄŸiÅŸiklik yoktu."
            exit 0
          fi
          
      - name: Kopyalanan hash dosyasÄ±nÄ± al
        run: |
          if [ -f temp/site_hash.txt ]; then
            cp temp/site_hash.txt site_hash.txt
          else
            echo "GeÃ§ici hash dosyasÄ± bulunamadÄ±. Ã‡Ä±kÄ±lÄ±yor."
            exit 0
          fi

      - name: Commit and push to state branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add site_hash.txt
          git commit -m "ğŸ”„ Hash gÃ¼ncellendi (deÄŸiÅŸiklik algÄ±landÄ±)" || echo "Commit yok"
          git pull origin state --rebase || echo "Rebase gerekmedi"
          git push origin state || echo "Push baÅŸarÄ±sÄ±z olabilir (deÄŸiÅŸiklik yoksa normaldir)"
